// Mobile responsive view tests
import { test, expect, devices } from '@playwright/test';

const MOBILE_VIEWPORTS = {
  'iPhone 12': devices['iPhone 12'],
  'iPhone SE': devices['iPhone SE'],
  'Pixel 5': devices['Pixel 5'],
  'Galaxy S9+': devices['Galaxy S9+'],
};

const TABLET_VIEWPORTS = {
  'iPad': devices['iPad (gen 7)'],
  'iPad Pro': devices['iPad Pro'],
};

// Test mobile viewport behavior
for (const [deviceName, device] of Object.entries(MOBILE_VIEWPORTS)) {
  test.describe(`Mobile: ${deviceName}`, () => {
    test.use(device);

    test('should show hamburger menu on mobile', async ({ page }) => {
      await page.goto('http://localhost:5173/');
      await page.waitForLoadState('networkidle');

      // Hamburger should be visible
      const hamburger = page.locator('.mobile-hamburger');
      await expect(hamburger).toBeVisible();

      // Activity bar should be hidden
      const activityBar = page.locator('.part.activitybar');
      await expect(activityBar).not.toBeVisible();

      // Take screenshot
      await page.screenshot({ path: `test-results/mobile-${deviceName.replace(/\s+/g, '-')}-home.png`, fullPage: true });
    });

    test('should open and close sidebar drawer', async ({ page }) => {
      await page.goto('http://localhost:5173/');
      await page.waitForLoadState('networkidle');

      // Open sidebar
      await page.click('.mobile-hamburger');
      await page.waitForTimeout(400); // Wait for animation

      // Sidebar should be visible
      const sidebar = page.locator('.part.sidebar');
      await expect(sidebar).toBeVisible();

      // Overlay should be visible
      const overlay = page.locator('.mobile-sidebar-overlay');
      await expect(overlay).toBeVisible();

      // Body should have open class
      await expect(page.locator('body')).toHaveClass(/mobile-sidebar-open/);

      // Take screenshot of open sidebar
      await page.screenshot({ path: `test-results/mobile-${deviceName.replace(/\s+/g, '-')}-sidebar-open.png`, fullPage: true });

      // Close by clicking overlay
      await page.click('.mobile-sidebar-overlay');
      await page.waitForTimeout(400);

      await expect(page.locator('body')).not.toHaveClass(/mobile-sidebar-open/);
    });

    test('should navigate and close sidebar', async ({ page }) => {
      await page.goto('http://localhost:5173/');
      await page.waitForLoadState('networkidle');

      // Open sidebar
      await page.click('.mobile-hamburger');
      await page.waitForTimeout(400);

      // Click a navigation item
      await page.click('[data-route="/decision-telemetry"]');
      await page.waitForTimeout(500);

      // Sidebar should close after navigation
      await expect(page.locator('body')).not.toHaveClass(/mobile-sidebar-open/);

      // URL should change
      expect(page.url()).toContain('/decision-telemetry');
    });

    test('should show bottom sheet drawer', async ({ page }) => {
      await page.goto('http://localhost:5173/');
      await page.waitForLoadState('networkidle');

      // Bottom sheet should be visible but collapsed
      const bottomSheet = page.locator('.mobile-bottom-sheet');
      await expect(bottomSheet).toBeVisible();

      // Should not be expanded initially
      await expect(bottomSheet).not.toHaveClass(/expanded/);
    });

    test('should expand bottom sheet on handle click', async ({ page }) => {
      await page.goto('http://localhost:5173/');
      await page.waitForLoadState('networkidle');

      // Click the handle
      await page.click('.mobile-bottom-sheet-handle');
      await page.waitForTimeout(400);

      // Should be expanded
      // Take screenshot of expanded bottom sheet
      await page.screenshot({ path: `test-results/mobile-${deviceName.replace(/\s+/g, '-')}-bottom-sheet-expanded.png`, fullPage: true });

      // Check bottomSheet has expanded class
      await expect(bottomSheet).toHaveClass(/expanded/);

      // Click again to collapse
      await page.click('.mobile-bottom-sheet-handle');
      await page.waitForTimeout(400);

      await expect(bottomSheet).not.toHaveClass(/expanded/);
    });

    test('should switch bottom sheet tabs', async ({ page }) => {
      await page.goto('http://localhost:5173/');
      await page.waitForLoadState('networkidle');

      // Expand bottom sheet
      await page.click('.mobile-bottom-sheet-handle');
      await page.waitForTimeout(400);

      // Check default tab
      const envelopeTab = page.locator('.mobile-bottom-sheet-tab[data-tab="envelope"]');
      await expect(envelopeTab).toHaveClass(/active/);

      // Click metrics tab
      await page.click('.mobile-bottom-sheet-tab[data-tab="metrics"]');
      await page.waitForTimeout(200);

      // Metrics tab should be active
      const metricsTab = page.locator('.mobile-bottom-sheet-tab[data-tab="metrics"]');
      await expect(metricsTab).toHaveClass(/active/);
    });

    test('should show panel FAB', async ({ page }) => {
      await page.goto('http://localhost:5173/');
      await page.waitForLoadState('networkidle');

      // FAB should be visible
      const fab = page.locator('.mobile-panel-fab');
      await expect(fab).toBeVisible();

      // Bottom panel should be hidden
      const panel = page.locator('.part.panel');
      await expect(panel).not.toBeVisible();
    });

    test('should open panel modal from FAB', async ({ page }) => {
      await page.goto('http://localhost:5173/');
      await page.waitForLoadState('networkidle');

      // Click FAB
      await page.click('.mobile-panel-fab');
      await page.waitForTimeout(400);

      // Modal should be visible
      const modal = page.locator('.mobile-panel-modal');
      await expect(modal).toBeVisible();
      await expect(modal).toHaveClass(/active/);

      // Close button should work
      await page.click('.mobile-panel-modal-header .codicon-close');
      await page.waitForTimeout(400);

      await expect(modal).not.toHaveClass(/active/);
    });

    test('should have touch-friendly timeline scrubber', async ({ page }) => {
      await page.goto('http://localhost:5173/');
      await page.waitForLoadState('networkidle');

      // Scrubber should be visible
      const scrubber = page.locator('#timeline-scrubber');
      await expect(scrubber).toBeVisible();

      // Handle should be larger for touch
      const handle = page.locator('.timeline-scrubber-handle');
      const box = await handle.boundingBox();
      expect(box.height).toBeGreaterThanOrEqual(32);
    });

    test('should hide specification button text', async ({ page }) => {
      await page.goto('http://localhost:5173/');
      await page.waitForLoadState('networkidle');

      // Button should be visible
      const specBtn = page.locator('.title-actions-button');
      await expect(specBtn).toBeVisible();

      // Text should be hidden (only icon visible)
      const buttonText = specBtn.locator('span:not(.codicon)');
      await expect(buttonText).not.toBeVisible();
    });

    test('should truncate title text', async ({ page }) => {
      await page.goto('http://localhost:5173/');
      await page.waitForLoadState('networkidle');

      // Title should be visible but truncated
      const title = page.locator('.title-text');
      await expect(title).toBeVisible();

      // Should have ellipsis styling
      const overflow = await title.evaluate(el => 
        window.getComputedStyle(el).textOverflow
      );
      expect(overflow).toBe('ellipsis');
    });

    test('should have single column layout', async ({ page }) => {
      await page.goto('http://localhost:5173/');
      await page.waitForLoadState('networkidle');

      // Main grid should be single column
      const workbench = page.locator('.workbench');
      const gridColumns = await workbench.evaluate(el => 
        window.getComputedStyle(el).gridTemplateColumns
      );

      // Should have only one column
      const columns = gridColumns.split(' ').filter(c => c.trim());
      expect(columns.length).toBe(1);
    });

    test('should hide all resize sashes', async ({ page }) => {
      await page.goto('http://localhost:5173/');
      await page.waitForLoadState('networkidle');

      // All sashes should be hidden
      const sashes = page.locator('.monaco-sash');
      const count = await sashes.count();

      for (let i = 0; i < count; i++) {
        await expect(sashes.nth(i)).not.toBeVisible();
      }
    });

    test('should adapt timeline controls layout', async ({ page }) => {
      await page.goto('http://localhost:5173/');
      await page.waitForLoadState('networkidle');

      // Play button should have min height for touch
      const playBtn = page.locator('#timeline-play');
      const box = await playBtn.boundingBox();
      expect(box.height).toBeGreaterThanOrEqual(40);

      // Scrubber should be full width
      const scrubber = page.locator('#timeline-scrubber');
      const scrubberBox = await scrubber.boundingBox();
      const viewport = page.viewportSize();
      
      // Scrubber should be close to viewport width (minus padding)
      expect(scrubberBox.width).toBeGreaterThan(viewport.width * 0.8);
    });
  });
}

// Test tablet viewport behavior
for (const [deviceName, device] of Object.entries(TABLET_VIEWPORTS)) {
  test.describe(`Tablet: ${deviceName}`, () => {
    test.use(device);

    test('should keep activity bar on tablet', async ({ page }) => {
      await page.goto('http://localhost:5173/');
      await page.waitForLoadState('networkidle');

      // Activity bar should be visible on tablet
      const activityBar = page.locator('.part.activitybar');
      await expect(activityBar).toBeVisible();

      // Hamburger should not be visible
      const hamburger = page.locator('.mobile-hamburger');
      await expect(hamburger).not.toBeVisible();
    });

    test('should hide auxiliary bar on tablet', async ({ page }) => {
      await page.goto('http://localhost:5173/');
      await page.waitForLoadState('networkidle');

      // Auxiliary bar should be hidden
      const auxiliaryBar = page.locator('.part.auxiliarybar');
      await expect(auxiliaryBar).not.toBeVisible();
    });

    test('should have narrower sidebar on tablet', async ({ page }) => {
      await page.goto('http://localhost:5173/');
      await page.waitForLoadState('networkidle');

      // Sidebar should be visible
      const sidebar = page.locator('.part.sidebar');
      await expect(sidebar).toBeVisible();

      // Should be 250px wide
      const width = await sidebar.evaluate(el => 
        window.getComputedStyle(el).width
      );
      expect(width).toBe('250px');
    });
  });
}

// Test landscape mobile orientation
test.describe('Mobile landscape', () => {
  test.use({
    viewport: { width: 844, height: 390 }, // iPhone 12 Pro Max landscape
  });

  test('should show sidebar alongside content in landscape', async ({ page }) => {
    await page.goto('http://localhost:5173/');
    await page.waitForLoadState('networkidle');

    // Sidebar should be visible without drawer
    const sidebar = page.locator('.part.sidebar');
    await expect(sidebar).toBeVisible();

    // Hamburger should not be visible
    const hamburger = page.locator('.mobile-hamburger');
    await expect(hamburger).not.toBeVisible();

    // Should have two-column layout
    const workbench = page.locator('.workbench');
    const gridColumns = await workbench.evaluate(el => 
      window.getComputedStyle(el).gridTemplateColumns
    );

    const columns = gridColumns.split(' ').filter(c => c.trim());
    expect(columns.length).toBeGreaterThan(1);
  });
});

// Test very small screens (<400px)
test.describe('Very small mobile', () => {
  test.use({
    viewport: { width: 375, height: 667 }, // iPhone SE
  });

  test('should force single column for grids', async ({ page }) => {
    await page.goto('http://localhost:5173/');
    await page.waitForLoadState('networkidle');

    // Check envelope grid if it exists
    const envelopeGrid = page.locator('.envelope-grid');
    if (await envelopeGrid.count() > 0) {
      const gridColumns = await envelopeGrid.evaluate(el => 
        window.getComputedStyle(el).gridTemplateColumns
      );
      
      // Should be single column
      expect(gridColumns).toContain('1fr');
    }
  });

  test('should have more compact timeline', async ({ page }) => {
    await page.goto('http://localhost:5173/');
    await page.waitForLoadState('networkidle');

    // Timeline bar should have reduced padding
    const timelineBar = page.locator('.timeline-bar');
    const padding = await timelineBar.evaluate(el => 
      window.getComputedStyle(el).padding
    );

    // Should have 4px padding
    expect(padding).toContain('4px');
  });
});

// Test touch interactions
test.describe('Touch interactions', () => {
  test.use(devices['iPhone 12']);

  test('should have minimum 44px touch targets', async ({ page }) => {
    await page.goto('http://localhost:5173/');
    await page.waitForLoadState('networkidle');

    // Open sidebar
    await page.click('.mobile-hamburger');
    await page.waitForTimeout(400);

    // Check nav items
    const navItems = page.locator('.monaco-list-row');
    const count = await navItems.count();

    for (let i = 0; i < count; i++) {
      const box = await navItems.nth(i).boundingBox();
      expect(box.height).toBeGreaterThanOrEqual(44);
    }
  });

  test('should support swipe gestures on bottom sheet', async ({ page }) => {
    await page.goto('http://localhost:5173/');
    await page.waitForLoadState('networkidle');

    const bottomSheet = page.locator('.mobile-bottom-sheet');
    
    // Simulate swipe up (touch events)
    const handle = page.locator('.mobile-bottom-sheet-handle');
    const box = await handle.boundingBox();
    
    await page.touchscreen.tap(box.x + box.width / 2, box.y + box.height / 2);
    await page.waitForTimeout(400);

    // Sheet should expand
    await expect(bottomSheet).toHaveClass(/expanded/);
  });
});
