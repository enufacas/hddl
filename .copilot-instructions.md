# HDDL Simulation Development Guidelines

## Test-Driven Verification Protocol

### Before Making Changes
1. **Identify the change**: Clearly document what needs to be modified
2. **Write the test first**: Create or update Playwright tests that verify the expected behavior
3. **Run existing tests**: Ensure current functionality isn't broken

### After Making Changes
1. **Run tests**: Execute `npm test` or `npx playwright test` to verify changes
2. **Verify server status**: Confirm the dev server is running and accessible
3. **Provide server link**: Always include the server URL (e.g., http://localhost:5175) in responses
4. **Visual verification**: Use Playwright to take screenshots or fetch webpage content to confirm UI changes

### Playwright Test Commands
```bash
# Run all tests
npx playwright test

# Run specific test file
npx playwright test tests/ui-verification.spec.js

# Run tests in headed mode (see browser)
npx playwright test --headed

# Run tests in debug mode
npx playwright test --debug

# Generate test code by recording interactions
npx playwright codegen http://localhost:5175
```

### Test Coverage Requirements
Every UI change should have tests verifying:
- ✅ Element visibility and positioning
- ✅ Interactive functionality (clicks, hovers, drags)
- ✅ Navigation and routing
- ✅ Modal/dialog behavior
- ✅ Data display accuracy
- ✅ Responsive layout structure

### Server Verification Checklist
Before completing any task:
- [ ] Verify dev server is running (`npm run dev`)
- [ ] Check port availability (5173, 5174, 5175)
- [ ] Test server response with fetch_webpage tool
- [ ] Provide clickable server URL in final response

### File Organization
```
hddl-sim/
├── tests/
│   ├── ui-verification.spec.js     # Main UI component tests
│   ├── navigation.spec.js          # Routing and navigation tests
│   ├── envelope-detail.spec.js     # Envelope modal tests
│   └── timeline.spec.js            # Timeline scrubber tests
├── src/
│   ├── pages/                      # Page components
│   ├── components/                 # Reusable components
│   └── main.js                     # App entry point
└── playwright.config.js            # Playwright configuration
```

### Continuous Integration
- Tests should run automatically on every commit
- All tests must pass before merging changes
- Failed tests should block deployment

### Documentation Standards
- Update tests when changing functionality
- Document test assumptions and expected behaviors
- Keep test descriptions clear and specific
- Use descriptive test names that explain what is being verified

### Common Test Patterns
```javascript
// Test element visibility
await expect(page.locator('.timeline-bar')).toBeVisible();

// Test text content
await expect(page.getByText('Decision Envelopes')).toBeVisible();

// Test user interactions
await page.locator('[data-envelope="ENV-001"]').click();

// Test navigation
await page.goto('/timeline');
await page.waitForURL('**/timeline');

// Test layout positioning
const box = await element.boundingBox();
expect(box.y).toBeLessThan(otherBox.y);

// Verify modal behavior
await page.waitForSelector('.modal', { timeout: 5000 });
await expect(modal).toBeVisible();
```

### Error Handling
- Always check server status before running tests
- Provide clear error messages when tests fail
- Include screenshots for visual regression issues
- Log console errors during test execution

### Performance Considerations
- Use `waitForLoadState('networkidle')` before assertions
- Set appropriate timeouts for async operations
- Avoid unnecessary waits (use smart waiting)
- Run tests in parallel when possible

## Agent Workflow
1. **Receive user request** → Document intended changes
2. **Write/update tests** → Create Playwright tests for new behavior
3. **Make code changes** → Implement the feature or fix
4. **Run tests** → Verify all tests pass
5. **Check server** → Confirm server is running and accessible
6. **Visual verification** → Use fetch_webpage or screenshots
7. **Report results** → Provide server link and test summary

## Server URL Template
Always format server links as markdown:
```markdown
✅ Server running at: **[http://localhost:5175](http://localhost:5175)**
```

## Test Failure Protocol
If tests fail:
1. Review error messages and stack traces
2. Check if server is running correctly
3. Verify CSS/JS changes haven't broken layout
4. Re-run specific failing test in headed mode
5. Fix issues and re-test
6. Document any known issues or limitations
